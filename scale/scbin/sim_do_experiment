#!/bin/sh

scriptdir=`dirname $0`
. $scriptdir/readconfig
cd $scriptdir

for n in 64 128 256 512; do
  logdir=${cassandra_log_dir}/n${n}
  rm -r $logdir/*
  mkdir -p $logdir
  cp scdeploy.conf.exp scdeploy.conf.$n
  echo "num_node=$n" >> scdeploy.conf.$n
  rm -r /tmp/n${n}
  mkdir /tmp/n${n}
  #./onemachine_dir_setup scdeploy.conf.$n
  rm /tmp/cass_scale/scale.log
  rm -r /tmp/cassandra/*
  export NODES=$n
  ./cpu > /tmp/cpu.${n} &
  #stdbuf -oL ./cpu2 > /tmp/cpu2.${n} &
  ./mem > /tmp/mem.$n &
  #./jps > /tmp/jps.$n &
  ./thread > /tmp/thread.$n &
  ./simio > /tmp/io.$n &
  ./simulation scdeploy.conf.$n $t
  sleep 90
  pkill java
  pkill cpu
  #pkill python
  pkill mem
  #pkill jps
  pkill thread
  pkill simio
  cp /tmp/cass_scale/scale.log* /tmp/n${n}
  i=1
  while [ $i -le $n ]; do
    a=`expr \( $i - 1 \) / 255`
    b=`expr \( $i - 1 \) % 255 + 1`
    echo $i 127.0.${a}.${b} >> /tmp/n${n}/machinelist
    i=`expr $i + 1`
  done
  cp -r /tmp/n${n}/* $logdir
  cp /tmp/cpu.${n} $logdir/cpu
  #cp /tmp/cpu2.${n} $logdir/cpu2
  cp /tmp/mem.${n} $logdir/mem
  cp /tmp/io.${n} $logdir/io
  cp /tmp/jps.${n} $logdir/jps
  cp /tmp/thread.${n} $logdir/thread
  cp /tmp/gc $logdir/gc
done
